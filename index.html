<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESMA Name-Change Sankey</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
  <style>
    body {
      font-family: Verdana, sans-serif;
      margin: 0; padding: 0;
      display: flex; justify-content: center; align-items: center;
      height: 100vh;
    }
    .link {
      fill: none; stroke-opacity: 0.5;
      transition: stroke-opacity 0.2s ease;
      will-change: stroke-opacity;
    }
    .link.highlight { stroke-opacity: 0.9; }
    .dimmed .link:not(.highlight) { stroke-opacity: 0.3; }
    .node rect {
      opacity: 0.5; transition: opacity 0.2s ease;
    }
    .node.highlight rect { opacity: 1 !important; }
    .dimmed .node rect:not(.highlight) { opacity: 0.3; }
    .tooltip {
      position: absolute; background: lightgrey;
      padding: 8px; border-radius: 5px;
      pointer-events: none; opacity: 0;
      transition: opacity 0.2s ease;
    }
    #amSelect {
      position: absolute; top: 20px; left: 30px;
      font-size: 12px; padding: 5px;
    }
    #chart { width: 100%; height: 100%; }
    svg { width: 100%; height: 100%; }
  </style>
</head>
<body>

  <select id="amSelect">
    <option value="All" selected>All</option>
    <option>Amundi</option>
    <option>BlackRock</option>
    <option>Deka</option>
    <option>Vanguard</option>
  </select>

  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const margin = { top: 50, right: 60, bottom: 60, left: 0 };
    const width  = 1100 - margin.left - margin.right;
    const height = 550  - margin.top  - margin.bottom;

    const svg = d3.select("#chart")
      .append("svg")
        .attr("viewBox", `0 0 1100 550`)
        .attr("preserveAspectRatio", "xMinYMin meet")
      .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select("#tooltip");

    const sankey = d3.sankey()
      .nodeWidth(20)
      .nodePadding(10)
      .extent([[1,1], [width-1, height-1]])
      .nodeAlign(d3.sankeyJustify);  // force only two columns

    const formatComma = d3.format(",");

    const color_map = [
      { min: 0,   max: 25,  color: '#586AAD' },
      { min: 25,  max: 50,  color: '#FFD371' },
      { min: 50,  max: 55,  color: '#f5b041' },
      { min: 55,  max: 60,  color: '#eb984e' },
      { min: 60,  max: 65,  color: '#dc7633' },
      { min: 65,  max: 70,  color: '#c0392b' },
      { min: 70,  max: 75,  color: '#a93226' },
      { min: 75,  max:100,  color: '#7b241c' },
      { min: null, max: null, color: '#f0f0f0' }
    ];
    function getColor(score) {
      const e = color_map.find(c => score >= c.min && score < c.max);
      return e ? e.color : '#000';
    }

    function loadChart(AMName) {
      Promise.all([
        d3.csv(`${AMName}_nodes.csv`),
        d3.csv(`${AMName}_links.csv`)
      ]).then(([nodes, links]) => {
        svg.selectAll("*").remove();

        // build nodes
        const graph = {
          nodes: nodes.map((d,i) => ({
            name: d.kategorie.trim(),
            score: null,
            index: i
          })),
          links: links
            .map(d => ({
              source: +d.source,
              target: +d.target,
              value:  +d.value
            }))
            // only keep leftâ†’right or self-links
            .filter(d => d.source <= d.target)
        };

        // compute layout
        const { nodes: svgn, links: svgl } = sankey(graph);

        // gradients
        const defs = svg.append("defs");
        svgl.forEach((d,i) => {
          const grad = defs.append("linearGradient")
            .attr("id", `grad${i}`)
            .attr("gradientUnits","userSpaceOnUse")
            .attr("x1", d.source.x1)
            .attr("x2", d.target.x0);
          grad.append("stop").attr("offset","0%")
              .attr("stop-color", getColor(null));
          grad.append("stop").attr("offset","100%")
              .attr("stop-color", getColor(null));
        });

        // draw links
        svg.append("g")
          .selectAll("path")
          .data(svgl)
          .enter().append("path")
            .attr("class","link")
            .attr("d", d3.sankeyLinkHorizontal())
            .attr("stroke-width", d => Math.max(1, d.width))
            .attr("stroke", (d,i) => `url(#grad${i})`)
            .on("mouseover", (e,d) => {
              svg.classed("dimmed", true);
              d3.select(e.currentTarget).classed("highlight", true);
              tooltip.style("opacity",1)
                .html(`mUS$ ${formatComma(Math.round(d.value))}`)
                .style("left", (e.pageX+10)+"px")
                .style("top", (e.pageY-10)+"px");
            })
            .on("mousemove", e => {
              tooltip.style("left",(e.pageX+10)+"px")
                     .style("top",(e.pageY-10)+"px");
            })
            .on("mouseout", () => {
              svg.classed("dimmed", false);
              d3.selectAll(".link").classed("highlight",false);
              tooltip.style("opacity",0);
            });

        // draw nodes
        const node = svg.append("g")
          .selectAll("g")
          .data(svgn)
          .enter().append("g")
            .attr("class","node")
            .attr("transform", d => `translate(${d.x0},${d.y0})`)
            .on("mouseover",(e,d) => {
              svg.classed("dimmed", true);
              d3.select(e.currentTarget).classed("highlight", true);
              tooltip.style("opacity",1)
                .html(`Node: ${d.name}`)
                .style("left",(e.pageX+10)+"px")
                .style("top",(e.pageY-10)+"px");
            })
            .on("mousemove", e => {
              tooltip.style("left",(e.pageX+10)+"px")
                     .style("top",(e.pageY-10)+"px");
            })
            .on("mouseout", () => {
              svg.classed("dimmed", false);
              d3.selectAll(".node").classed("highlight", false);
              tooltip.style("opacity",0);
            });

        node.append("rect")
          .attr("width", sankey.nodeWidth())
          .attr("height", d => d.y1 - d.y0)
          .attr("fill", d => getColor(d.score));

        node.append("text")
          .attr("x", d => d.depth === 0
                         ? sankey.nodeWidth() + 6
                         : -6)
          .attr("y", d => (d.y1 - d.y0)/2)
          .attr("dy", "0.35em")
          .attr("text-anchor", d => d.depth === 0 ? "start" : "end")
          .style("font-size","12px")
          .text(d => d.name);

      }).catch(err => console.error("Error loading CSVs:", err));
    }

    // wire up dropdown
    document.getElementById("amSelect")
      .addEventListener("change", function() {
        loadChart(this.value);
      });

    // initial draw
    loadChart("All");
  </script>
</body>
</html>
