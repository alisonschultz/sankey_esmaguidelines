<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESMA Name-Change Sankey</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
  <style>
    body { font-family: sans-serif; margin:0; }
    #controls { padding:10px; }
    #chart svg { width:100%; height:600px; }
    .node rect { stroke: #000; }
    .link { fill:none; stroke-opacity:0.5; }
  </style>
</head>
<body>

  <div id="controls">
    Asset Manager:
    <select id="amSelect">
      <option value="All" selected>All</option>
      <!-- you can fill these with your actual managers -->
      <option>Amundi</option>
      <option>BlackRock</option>
      <option>Deka</option>
      <option>Vanguard</option>
      <!-- …etc… -->
    </select>
  </div>

  <div id="chart"></div>

  <script>
  // dimensions
  const width  = 1000;
  const height = 600;
  const margin = { top: 10, right: 10, bottom: 10, left: 10 };

  const svg = d3.select("#chart")
    .append("svg")
      .attr("viewBox", [0, 0, width, height]);

  const sankeyGen = d3.sankey()
    .nodeWidth(20)
    .nodePadding(10)
    .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);

  // load both CSVs once
  
Promise.all([
  d3.csv("./all_nodes.csv"),
  d3.csv("./all_links.csv")
  ]).then(([rawNodes, rawLinks]) => {

    // parse nodes
    const allNodes = rawNodes.map(d => ({
      name:   d.kategorie,
      color:  d.color,
      id:     +d.node_id
    }));

    // parse links
    const allLinks = rawLinks.map(d => ({
      source: +d.source,
      target: +d.target,
      value:  +d.value,
      manager: d.asset_manager || "All"  // if you included asset_manager col in links
    }));

    // draw given a filter
    function draw(manager) {
      svg.selectAll("*").remove();

      // filter links by manager or show all
      const links = manager === "All"
        ? allLinks
        : allLinks.filter(d => d.manager === manager);

      // recompute sankey layout
      const graph = { nodes: allNodes.map(d=>Object.assign({},d)), links: links.map(d=>Object.assign({},d)) };
      sankeyGen(graph);

      // defs for gradients
      const defs = svg.append("defs");
      graph.links.forEach((link, i) => {
        const grad = defs.append("linearGradient")
          .attr("id", "grad"+i)
          .attr("gradientUnits", "userSpaceOnUse")
          .attr("x1", link.source.x1)
          .attr("x2", link.target.x0);
        grad.append("stop").attr("offset", "0%").attr("stop-color", graph.nodes[link.source.index].color);
        grad.append("stop").attr("offset", "100%").attr("stop-color", graph.nodes[link.target.index].color);
      });

      // draw links
      svg.append("g")
        .selectAll("path")
        .data(graph.links)
        .enter().append("path")
          .attr("class","link")
          .attr("d", d3.sankeyLinkHorizontal())
          .attr("stroke", (d,i) => `url(#grad${i})`)
          .attr("stroke-width", d => Math.max(1, d.width));

      // draw nodes
      const nodeG = svg.append("g")
        .selectAll("g")
        .data(graph.nodes)
        .enter().append("g")
          .attr("class","node")
          .attr("transform", d => `translate(${d.x0},${d.y0})`);

      nodeG.append("rect")
        .attr("height", d => d.y1 - d.y0)
        .attr("width", d => sankeyGen.nodeWidth())
        .attr("fill", d => d.color);

      nodeG.append("text")
        .attr("x", d => d.x0 < width/2 ? sankeyGen.nodeWidth()+6 : -6)
        .attr("y", d => (d.y1 - d.y0)/2)
        .attr("dy","0.35em")
        .attr("text-anchor", d => d.x0 < width/2 ? "start" : "end")
        .text(d => d.name);
    }

    // initial draw
    draw("All");

    // wire up dropdown
    d3.select("#amSelect").on("change", function() {
      draw(this.value);
    });
  });    
  </script>
</body>
</html>
