<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESMA Name-Change Sankey</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-sankey@0.12.3"></script>
  <style>
    body {
      font-family: Verdana, sans-serif;
      margin:0; padding:0;
      display:flex; justify-content:center; align-items:center;
      height:100vh;
    }
    .link {
      fill:none; stroke-opacity:0.5;
      transition:stroke-opacity 0.2s ease;
    }
    .link.highlight { stroke-opacity:0.9; }
    .dimmed .link:not(.highlight) { stroke-opacity:0.3; }
    .node rect {
      opacity:0.5; transition:opacity 0.2s ease;
    }
    .node.highlight rect { opacity:1 !important; }
    .dimmed .node rect:not(.highlight) { opacity:0.3; }
    .tooltip {
      position:absolute; background:lightgrey;
      padding:8px; border-radius:5px;
      pointer-events:none; opacity:0;
      transition:opacity 0.2s ease;
    }
    #chart { width:100%; height:100%; }
    svg { width:100%; height:100%; }
  </style>
</head>
<body>

  <!-- only one option now -->
  <select id="amSelect">
    <option value="all" selected>Alle Asset Managers</option>
  </select>

  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <script>
  // margins + svg setup
  const margin = { top:50, right:60, bottom:60, left:0 };
  const fullW = 1100, fullH = 550;
  const width  = fullW  - margin.left - margin.right;
  const height = fullH  - margin.top  - margin.bottom;

  const svg = d3.select("#chart")
    .append("svg")
      .attr("viewBox", `0 0 ${fullW} ${fullH}`)
      .attr("preserveAspectRatio","xMinYMin meet")
    .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

  const tooltip = d3.select("#tooltip");

  // sankey generator: two columns only
  const sankey = d3.sankey()
    .nodeWidth(20)
    .nodePadding(10)
    .extent([[1,1], [width-1, height-1]])
    .nodeAlign(d3.sankeyJustify);

  const formatComma = d3.format(",");

  function loadChart() {
    Promise.all([
      d3.csv("all_nodes.csv"),
      d3.csv("all_links.csv")
    ])
    .then(([nodesRaw, linksRaw]) => {
      svg.selectAll("*").remove();

      // build nodes array
      const nodes = nodesRaw.map((d,i) => ({
        name:  d.kategorie.trim(),
        color: d.color,
        index: i
      }));

      // build links, mapping via index, keep source<=target
      const links = linksRaw
        .map(d => {
          const sName = d.source_kategorie.trim();
          const tName = d.target_kategorie.trim();
          const s = nodes.findIndex(n => n.name === sName);
          const t = nodes.findIndex(n => n.name === tName);
          return (s<0||t<0) ? null : { source: s, target: t, value: +d.value };
        })
        .filter(d => d && d.source <= d.target);

      const graph = { nodes, links };
      const { nodes: Gnodes, links: Glinks } = sankey(graph);

      // gradients
      const defs = svg.append("defs");
      Glinks.forEach((link,i) => {
        const grad = defs.append("linearGradient")
          .attr("id",`grad${i}`)
          .attr("gradientUnits","userSpaceOnUse")
          .attr("x1", link.source.x1)
          .attr("x2", link.target.x0);
        grad.append("stop")
          .attr("offset","0%")
          .attr("stop-color", nodes[link.source.index].color);
        grad.append("stop")
          .attr("offset","100%")
          .attr("stop-color", nodes[link.target.index].color);
      });

      // draw links
      svg.append("g")
        .selectAll("path")
        .data(Glinks)
        .enter().append("path")
          .attr("class","link")
          .attr("d", d3.sankeyLinkHorizontal())
          .attr("stroke-width", d => Math.max(1,d.width))
          .attr("stroke", (d,i) => `url(#grad${i})`)
          .on("mouseover",(e,d)=>{
            svg.classed("dimmed",true);
            d3.select(e.currentTarget).classed("highlight",true);
            tooltip
              .style("opacity",1)
              .html(`mUS$ ${formatComma(Math.round(d.value))}`)
              .style("left", (e.pageX+10)+"px")
              .style("top",  (e.pageY-10)+"px");
          })
          .on("mousemove", e=>{
            tooltip
              .style("left",(e.pageX+10)+"px")
              .style("top", (e.pageY-10)+"px");
          })
          .on("mouseout", ()=>{
            svg.classed("dimmed",false);
            d3.selectAll(".link").classed("highlight",false);
            tooltip.style("opacity",0);
          });

      // draw nodes
      const node = svg.append("g")
        .selectAll("g")
        .data(Gnodes)
        .enter().append("g")
          .attr("class","node")
          .attr("transform", d=>`translate(${d.x0},${d.y0})`)
          .on("mouseover",(e,d)=>{
            svg.classed("dimmed",true);
            d3.select(e.currentTarget).classed("highlight",true);
            tooltip
              .style("opacity",1)
              .html(d.name)
              .style("left",(e.pageX+10)+"px")
              .style("top", (e.pageY-10)+"px");
          })
          .on("mousemove", e=>{
            tooltip
              .style("left",(e.pageX+10)+"px")
              .style("top", (e.pageY-10)+"px");
          })
          .on("mouseout", ()=>{
            svg.classed("dimmed",false);
            d3.selectAll(".node").classed("highlight",false);
            tooltip.style("opacity",0);
          });

      node.append("rect")
        .attr("width", sankey.nodeWidth())
        .attr("height", d => d.y1 - d.y0)
        .attr("fill", d => d.color);

      node.append("text")
        .attr("x", d => d.depth===0
                       ? sankey.nodeWidth()+6
                       : -6)
        .attr("y", d => (d.y1-d.y0)/2)
        .attr("dy","0.35em")
        .attr("text-anchor", d=> d.depth===0 ? "start":"end")
        .style("font-size","12px")
        .text(d=>d.name);

    })
    .catch(err => console.error("Failed to load CSVs:", err));
  }

  // wire up + initial draw
  document.getElementById("amSelect")
    .addEventListener("change", loadChart);
  loadChart();  // always “all”
  </script>
</body>
</html>
