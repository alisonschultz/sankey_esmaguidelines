<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reaktion auf ESMA-Leitlinien zu Fonds-Namen</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3"></script>

    <!-- Inline CSS -->
    <style>
        body {
            font-family: Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .link {
            fill: none;
            stroke-opacity: 0.5;
            transition: stroke-opacity 0.2s ease;
            will-change: stroke-opacity;
        }

        .link.highlight {
            stroke-opacity: 0.9;
        }

        .dimmed .link:not(.highlight) {
            stroke-opacity: 0.3;
        }

        .node rect {
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }

        .node.highlight rect {
            opacity: 1 !important;
        }

        .dimmed .node rect:not(.highlight) {
            opacity: 0.3;
        }

        .node text {
            opacity: 1 !important;
        }

        .tooltip {
            position: absolute;
            background: lightgrey;
            padding: 8px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        #amSelect {
            position: absolute;
            top: 20px;
            left: 30px;
            font-family: Verdana, sans-serif;
            font-size: 12px;
            padding: 5px;
        }

        #chart {
            width: 100%;
            height: 100%;
        }

        svg {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <select id="amSelect">
        <option value="all">Alle Asset Managers</option>
        <option value="Barclays">Barclays</option>
        <option value="BNP Paribas">BNP Paribas</option>
        <option value="Citigroup" selected>Citigroup</option>
        <option value="CommBank" selected>CommBank</option>
        <option value="Deutsche Bank">Deutsche Bank</option>
        <option value="HSBC">HSBC</option>
        <option value="NAB">NAB</option>
        <option value="RBC">RBC</option>
        <option value="UBS">UBS</option>
        <option value="Westpac">Westpac</option>
    </select>

    <div id="chart"></div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        const margin = { top: 50, bottom: 60, left: 0, right: 60 }; // Adjusted margins

        const svg = d3.select("#chart")
            .append("svg")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("viewBox", `0 0 1100 550`) // Increased viewBox size to prevent cut-off
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const tooltip = d3.select("#tooltip");

        const sankey = d3.sankey()
            .nodeWidth(20)
            .nodePadding(10)
            .extent([[1, 1], [1100 - 2 - margin.right, 550 - 2 - margin.bottom]])
            .nodeSort((a, b) => b.aggregateValue - a.aggregateValue); // Sort nodes by size

        const formatComma = d3.format(",");

        function removeCircularLinks(links) {
            return links.filter(link => link.source !== link.target);
        }

        function sortLinksByValue(links) {
            return links.sort((a, b) => b.value - a.value);
        }

        function calculateAggregateValue(node, links) {
            const incoming = d3.sum(links.filter(link => link.target === node.index), link => link.value);
            const outgoing = d3.sum(links.filter(link => link.source === node.index), link => link.value);
            return incoming + outgoing;
        }

        function cleanLabel(label) {
            return label.replace(/(_subsidiary|_parent)$/, '');
        }

        function loadChart(amName) {
            const nodesFile = `${amName}_nodes.csv`;
            const linksFile = `${amName}_links.csv`;

            Promise.all([d3.csv(nodesFile), d3.csv(linksFile)]).then(([nodes, links]) => {
                svg.selectAll("*").remove();  // Clear previous chart

                const graph = {
                    nodes: nodes.map((d, i) => ({
                        name: d.name.trim(),
                        index: i,
                        aggregateValue: 0
                    })),
                    links: sortLinksByValue(removeCircularLinks(links.map(d => {
                        const sourceIdx = nodes.findIndex(node => node.name.trim() === d.source.trim());
                        const targetIdx = nodes.findIndex(node => node.name.trim() === d.target.trim());

                        if (sourceIdx === -1 || targetIdx === -1) {
                            console.error('Invalid link with undefined source/target:', d);
                            return null;
                        }

                        return {
                            source: sourceIdx,
                            target: targetIdx,
                            value: +d.value
                        };
                    }).filter(d => d !== null)))
                };

                graph.nodes.forEach(node => {
                    node.aggregateValue = calculateAggregateValue(node, graph.links);
                });

                const sankeyData = sankey(graph);

                const defs = svg.append("defs");

                const link = svg.append("g")
                    .selectAll(".link")
                    .data(sankeyData.links)
                    .enter()
                    .append("path")
                    .attr("class", "link")
                    .attr("d", d3.sankeyLinkHorizontal())
                    .attr("stroke-width", d => Math.max(1, d.width))
                    .attr("stroke", (d, i) => `url(#grad${i})`)
                    .on("mouseover", function (event, d) {
                        svg.classed("dimmed", true);
                        d3.select(this).classed("highlight", true).attr("stroke-opacity", 0.9);

                        d3.select(`#node-${d.source.index}`).classed("highlight", true);
                        d3.select(`#node-${d.target.index}`).classed("highlight", true);

                        tooltip.style("opacity", 1)
                            .html(`mUS$ ${formatComma(Math.round(d.value))}`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                    })
                    .on("mousemove", function (event) {
                        tooltip.style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                    })
                    .on("mouseout", function () {
                        svg.classed("dimmed", false);
                        d3.select(this).classed("highlight", false).attr("stroke-opacity", 0.5);

                        d3.selectAll(".node").classed("highlight", false);

                        tooltip.style("opacity", 0);
                    });

                const node = svg.append("g")
                    .selectAll(".node")
                    .data(sankeyData.nodes)
                    .enter()
                    .append("g")
                    .attr("class", "node")
                    .attr("id", d => `node-${d.index}`)
                    .attr("transform", d => `translate(${d.x0},${d.y0})`)
                    .on("mouseover", function (event, d) {
                        svg.classed("dimmed", true);
                        d3.select(this).classed("highlight", true);

                        link.filter(l => l.source === d || l.target === d)
                            .classed("highlight", true)
                            .attr("stroke-opacity", 0.9);
                    })
                    .on("mousemove", function (event) {
                        tooltip.style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                    })
                    .on("mouseout", function () {
                        svg.classed("dimmed", false);
                        d3.select(this).classed("highlight", false);

                        link.classed("highlight", false).attr("stroke-opacity", 0.5);

                        tooltip.style("opacity", 0);
                    });

                node.append("rect")
                    .attr("height", d => d.y1 - d.y0)
                    .attr("width", sankey.nodeWidth());

                node.append("text")
                    .attr("x", d => {
                        if (d.depth === 0) {
                            return sankey.nodeWidth() - 5;
                        } else if (d.depth === 2) {
                            return sankey.nodeWidth() + 5;
                        } else {
                            return sankey.nodeWidth() / 2;
                        }
                    })
                    .attr("y", d => (d.y1 - d.y0) / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", d => d.depth === 0 ? "start" : (d.depth === 2 ? "end" : "middle"))
                    .style("font-size", "12px")
                    .text(d => cleanLabel(d.name));
            });
        }

        document.getElementById('amSelect').addEventListener('change', function () {
            const bank = this.value;
            loadChart(bank);
        });

        loadChart('Citigroup');
    </script>
</body>

</html>