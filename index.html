<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>ESMA Name-Change Sankey (AM & Reihenfolge)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-sankey@0.12.3"></script>
  <style>
    body {
      font-family: Verdana, sans-serif;
      margin:0; padding:0;
      display:flex; flex-direction:column;
      align-items:center; height:100vh;
    }
    #controls { margin:10px; }
    .link {
      fill:none; stroke-opacity:0.5;
      transition:stroke-opacity 0.2s ease;
    }
    .link.highlight { stroke-opacity:0.9; }
    .dimmed .link:not(.highlight) { stroke-opacity:0.3; }
    .node rect {
      opacity:0.6; transition:opacity 0.2s ease;
    }
    .node.highlight rect { opacity:1 !important; }
    .dimmed .node rect:not(.highlight) { opacity:0.3; }
    .tooltip {
      position:absolute; background:lightgrey;
      padding:6px; border-radius:4px;
      pointer-events:none; opacity:0;
      transition:opacity 0.2s ease;
    }
    #chart { flex:1; width:100%; }
    svg { width:100%; height:100%; }
  </style>
</head>
<body>

  <div id="controls">
    <label for="amSelect">Asset Manager:</label>
    <select id="amSelect">
      <option value="all" selected>Alle Asset Manager</option>
      <option value="test">Test Asset Manager</option>
      <!-- Weitere hier -->
    </select>
  </div>

  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    // Layout
    const margin = { top:40, right:20, bottom:40, left:20 };
    const fullW = 800, fullH = 500;
    const width  = fullW  - margin.left - margin.right;
    const height = fullH  - margin.top  - margin.bottom;

    // SVG
    const svg = d3.select("#chart")
      .append("svg")
        .attr("viewBox", `0 0 ${fullW} ${fullH}`)
        .attr("preserveAspectRatio","xMinYMin meet")
      .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select("#tooltip");
    const fmt = d3.format(",");

    // Sankey mit 2 Spalten
    const sankey = d3.sankey()
      .nodeWidth(20)
      .nodePadding(10)
      .extent([[1,1],[width-1,height-1]])
      .nodeAlign(d3.sankeyJustify);

    // DEINE gewünschte Reihenfolge
    const order = [
      "sustainable",
      "environment",
      "transition",
      "impact",
      "social",
      "watchlist term",
      "Begriff nicht ESMA-relevant"
    ];

    function loadChart(prefix) {
      Promise.all([
        d3.csv(`${prefix}_nodes.csv`),
        d3.csv(`${prefix}_links.csv`)
      ])
      .then(([nodesRaw, linksRaw]) => {
        // ––– 1) Sortiere ONCE nach order –––
        nodesRaw.sort((a,b) =>
          order.indexOf(a.kategorie.trim()) - order.indexOf(b.kategorie.trim())
        );
        const N = nodesRaw.length;

        // ––– 2) Dupliziere die *sortierte* Liste für links & rechts –––
        const sankeyNodes = nodesRaw
          .map(d => ({ name:d.kategorie.trim(), color:d.color, col:"L" }))
          .concat(
            nodesRaw.map(d => ({ name:d.kategorie.trim(), color:d.color, col:"R" }))
          );

        // ––– 3) Baue die Links left→right auf –––
        const sankeyLinks = linksRaw
          .map(d => {
            const s = order.indexOf(d.source_kategorie.trim());
            const t = order.indexOf(d.target_kategorie.trim());
            if (s<0||t<0) return null;
            return { source:s, target:N+t, value:+d.value };
          })
          .filter(d=>d);

        // ––– 4) Layout berechnen –––
        const { nodes: Gnodes, links: Glinks } = sankey({
          nodes: sankeyNodes,
          links: sankeyLinks
        });

        // Clear & Gradients
        svg.selectAll("*").remove();
        const defs = svg.append("defs");
        Glinks.forEach((l,i) => {
          const grad = defs.append("linearGradient")
            .attr("id",`grad${i}`)
            .attr("gradientUnits","userSpaceOnUse")
            .attr("x1", l.source.x1)
            .attr("x2", l.target.x0);
          grad.append("stop").attr("offset","0%")
              .attr("stop-color", sankeyNodes[l.source.index].color);
          grad.append("stop").attr("offset","100%")
              .attr("stop-color", sankeyNodes[l.target.index].color);
        });

        // ––– 5) Links zeichnen –––
        svg.append("g")
          .selectAll("path")
          .data(Glinks)
          .enter().append("path")
            .attr("class","link")
            .attr("d", d3.sankeyLinkHorizontal())
            .attr("stroke-width", d=>Math.max(1,d.width))
            .attr("stroke",(d,i)=>`url(#grad${i})`)
            .on("mouseover",(e,d)=>{ /* … */ });

        // ––– 6) Knoten zeichnen –––
        const node = svg.append("g")
          .selectAll("g")
          .data(Gnodes)
          .enter().append("g")
            .attr("transform",d=>`translate(${d.x0},${d.y0})`)
            .on("mouseover",(e,d)=>{ /* … */ });

        node.append("rect")
          .attr("width", sankey.nodeWidth())
          .attr("height",d=>d.y1-d.y0)
          .attr("fill",d=>d.color);

        node.append("text")
          .attr("x", d=> d.col==="L" ? sankey.nodeWidth()+6 : -6)
          .attr("y", d=> (d.y1-d.y0)/2)
          .attr("dy","0.35em")
          .attr("text-anchor",d=> d.col==="L"?"start":"end")
          .style("font-size","12px")
          .text(d=>d.name);

      })
      .catch(err => console.error("Fehler beim Laden der CSVs:", err));
    }

    // Dropdown & Initialisierung
    d3.select("#amSelect").on("change", function() {
      loadChart(this.value);
    });
    loadChart("all");
  </script>
</body>
</html>
